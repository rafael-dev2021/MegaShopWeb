@model Application.Dtos.OrderDtos.OrderDto

<style>
    .form-group input[type="text"],
    .form-group input[type="tel"],
    .form-group input[type="email"],
    .form-group input[type="password"] {
        height: 50px;
    }

    .css-voc button[type="submit"] {
        width: 100%;
        height: 40px;
        background-color: blue;
        border: none;
        color: white;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    .css-voc .form-group {
        margin-bottom: 15px;
    }
</style>

<form asp-action="Checkout" method="post" role="form">
    @Html.AntiForgeryToken()
    <div class="text-center mb-4 container" style="background-color:#B12704 !important;padding:10px">
        <span style="font-size:18px">
            <a asp-controller="ShoppingCart" asp-action="Index" style="color:white">
                Cart
            </a>
            <a asp-controller="ShoppingCart" asp-action="ItemReview" style="color:white">
                > Item Review >
            </a>
            <a asp-controller="Order" asp-action="Checkout" style="color:deepskyblue">
                Checkout
            </a>
            <span style="color:white">
                > Order Detail
            </span>
        </span>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-8">
                <div class="card-header" style="border: 1px solid lightgray;border-radius:5px">
                    <h4 class="card-title">Shipping address</h4>
                </div>
                <div class="row">
                    <div class="form-group mb-3 mt-2">
                        <label asp-for="DeliveryAddress.Country" class="control-label">Country</label>
                        <input id="country" asp-for="DeliveryAddress.Country" class="form-control" />
                        <span asp-validation-for="DeliveryAddress.Country" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-6">
                        <label asp-for="UserDelivery.FirstName" class="control-label">First name</label>
                        <input asp-for="UserDelivery.FirstName" class="form-control" />
                        <span asp-validation-for="UserDelivery.FirstName" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-6">
                        <label asp-for="UserDelivery.LastName" class="control-label">Last name</label>
                        <input asp-for="UserDelivery.LastName" class="form-control" />
                        <span asp-validation-for="UserDelivery.LastName" class="text-danger"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="form-group mb-3 mt-2">
                        <div class="form-group col-md-6">
                            <label asp-for="UserDelivery.Email" class="control-label">Email</label>
                            <input asp-for="UserDelivery.Email" class="form-control" />
                            <span asp-validation-for="UserDelivery.Email" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group col-md-6">
                        <label asp-for="UserDelivery.SSN" class="control-label">SSN</label>
                        <input id="ssn" asp-for="UserDelivery.SSN" placeholder="SSN" class="form-control" />
                        <span asp-validation-for="UserDelivery.SSN" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-6">
                        <label asp-for="UserDelivery.Phone" class="control-label">Phone</label>
                        <input id="phoneNumber" asp-for="UserDelivery.Phone" placeholder="Phone number" class="form-control" />
                        <span asp-validation-for="UserDelivery.Phone" class="text-danger"></span>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="DeliveryAddress.ZipCode" class="control-label">Zip code</label>
                    <input id="zipCode" asp-for="DeliveryAddress.ZipCode" placeholder="Zip code" class="form-control" />
                    <span asp-validation-for="DeliveryAddress.ZipCode" class="text-danger"></span>
                </div>

                <div class="row">
                    <div class="form-group col-md-6">
                        <label asp-for="DeliveryAddress.State" class="control-label">State</label>
                        <input id="state" asp-for="DeliveryAddress.State" placeholder="State" class="form-control" />
                        <span asp-validation-for="DeliveryAddress.State" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-6">
                        <label asp-for="DeliveryAddress.City" class="control-label">City</label>
                        <input id="city" asp-for="DeliveryAddress.City" placeholder="City" class="form-control" />
                        <span asp-validation-for="DeliveryAddress.City" class="text-danger"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group col-md-6">
                        <label asp-for="DeliveryAddress.Address" class="control-label">Address</label>
                        <input id="logradouro" asp-for="DeliveryAddress.Address" placeholder="Address" class="form-control" />
                        <span asp-validation-for="DeliveryAddress.Address" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-6">
                        <label asp-for="DeliveryAddress.Neighborhood" class="control-label">Neighborhood</label>
                        <input id="neighborhood" asp-for="DeliveryAddress.Neighborhood" placeholder="Neighborhood" class="form-control" />
                        <span asp-validation-for="DeliveryAddress.Neighborhood" class="text-danger"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="DeliveryAddress.Complement" class="control-label">Complement</label>
                    <input asp-for="DeliveryAddress.Complement" placeholder="Apartment, Suite, Unit, Building, Floor, etc.(Optional)" class="form-control" />
                    <span asp-validation-for="DeliveryAddress.Complement" class="text-danger"></span>
                </div>
                <div class="justify-content-lg-end d-flex">
                    <p>
                        Upon completion, you agree to
                        <a asp-controller="Home" asp-action="Privacy">Privay Policy</a>
                        and
                        <a asp-controller="" asp-action="#">Cookies</a>
                    </p>
                </div>
                <div class="row css-voc">
                    <div class="form-group col-md-3">
                        <button type="submit" value="Finish">Finish order</button>
                    </div>
                </div>
            </div>


            <div class="col-md-4">
                <div class="card-header" style="border:1px solid lightgray;border-radius:5px">
                    <h4 class="card-title">Payment data</h4>
                </div>
                <div class="card mt-2" style="line-height:20px">
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="PaymentMethod" class="form-label">Payment method:</label>
                            <select id="PaymentMethod" name="Payment.PaymentMethod" class="form-control">
                                <option value="">Select payment method</option>
                                @foreach (var paymentMethod in Enum.GetValues(typeof(Domain.Entities.Payments.Enums.EPaymentMethod)))
                                {
                                    var paymentMethodValue = (Domain.Entities.Payments.Enums.EPaymentMethod)paymentMethod;
                                    <option value="@paymentMethodValue">@Domain.Entities.Payments.Enums.EPaymentMethodHelper.GetDescription(paymentMethodValue)</option>
                                }
                            </select>
                            <span asp-validation-for="PaymentMethod.PaymentMethodObjectValue.EPaymentMethod" class="text-danger"></span>
                        </div>

                        <div id="creditCardFields"  style="display:none;">
                            <div class="mb-3">
                                <input asp-for="PaymentMethod.CreditCard.CardNumber" id="CardNumber" placeholder="Card number" class="form-control" />
                                <span id="CardBrand" class="text-muted"></span>
                                <span asp-validation-for="PaymentMethod.CreditCard.CardNumber" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <input asp-for="PaymentMethod.CreditCard.SSN" placeholder="SSN" class="form-control" />
                                <span asp-validation-for="PaymentMethod.CreditCard.SSN" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <input asp-for="PaymentMethod.CreditCard.CardHolderName" placeholder="Holder name" class="form-control" />
                                <span asp-validation-for="PaymentMethod.CreditCard.CardHolderName" class="text-danger"></span>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <input asp-for="PaymentMethod.CreditCard.CardExpirationDate" id="ExpirationDate" placeholder="Expiration date" class="form-control" />
                                    <span asp-validation-for="PaymentMethod.CreditCard.CardExpirationDate" class="text-danger"></span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <input asp-for="PaymentMethod.CreditCard.CardCVV" placeholder="Security code" class="form-control" />
                                    <span asp-validation-for="PaymentMethod.CreditCard.CardCVV" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div id="debitCardFields" style="display:none;">
                            <div class="mb-3 debit-card">
                                <input asp-for="PaymentMethod.DebitCard.CardNumber" id="DebitCardNumber" placeholder="Debit Card number" class="form-control" />
                                <span id="DebitCardBrand" class="text-muted"></span>
                                <span asp-validation-for="PaymentMethod.DebitCard.CardNumber" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <input asp-for="PaymentMethod.DebitCard.SSN" placeholder="SSN" class="form-control" />
                                <span asp-validation-for="PaymentMethod.DebitCard.SSN" class="text-danger"></span>
                            </div>
                            <div class="mb-3 debit-card">
                                <input asp-for="PaymentMethod.DebitCard.CardHolderName" placeholder="Holder name" class="form-control" />
                                <span asp-validation-for="PaymentMethod.DebitCard.CardHolderName" class="text-danger"></span>
                            </div>
                            <div class="row debit-card">
                                <div class="col-md-6 mb-3">
                                    <input asp-for="PaymentMethod.DebitCard.CardExpirationDate" id="DebitExpirationDate" placeholder="Expiration date" class="form-control" />
                                    <span asp-validation-for="PaymentMethod.DebitCard.CardExpirationDate" class="text-danger"></span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <input asp-for="PaymentMethod.DebitCard.CardCVV" placeholder="Security code" class="form-control" />
                                    <span asp-validation-for="PaymentMethod.DebitCard.CardCVV" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Adicione este campo oculto para armazenar o valor do método de pagamento escolhido -->
                        <input type="hidden" id="SelectedPaymentMethod" name="SelectedPaymentMethod" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        // Função para ser chamada quando o método de pagamento é alterado
        function handlePaymentMethodChange() {
            // Obtenha o elemento do dropdown
            var paymentMethodDropdown = document.getElementById("PaymentMethod");

            // Obtenha o valor selecionado
            var selectedPaymentMethod = paymentMethodDropdown.value;

            // Atualize o campo oculto com o valor selecionado
            document.getElementById("SelectedPaymentMethod").value = selectedPaymentMethod;

            // Exiba ou oculte os campos do cartão de crédito conforme necessário
            var creditCardFields = document.getElementById("creditCardFields");
            if (selectedPaymentMethod === "CreditCard") {
                creditCardFields.style.display = "block";
            } else {
                creditCardFields.style.display = "none";
            }
            // Exiba ou oculte os campos do cartão de crédito conforme necessário
            var debitCardFields = document.getElementById("debitCardFields");
            if (selectedPaymentMethod === "DebitCard") {
                debitCardFields.style.display = "block";
            } else {
                debitCardFields.style.display = "none";
            }
        }

        var paymentMethodDropdown = document.getElementById("PaymentMethod");
        paymentMethodDropdown.addEventListener("change", handlePaymentMethodChange);

        handlePaymentMethodChange();

        const expirationDateInput = document.getElementById('ExpirationDate');
        expirationDateInput.addEventListener('input', (event) => {
            const input = event.target;
            let value = input.value;
            value = value.replace(/\D/g, '');
            if (value.length > 2) {
                value = value.slice(0, 2) + '/' + value.slice(2);
            }
            input.value = value;
        });

        const cardNumberInput = document.getElementById('CardNumber');
        const cardBrandSpan = document.getElementById('CardBrand');
        cardNumberInput.addEventListener('input', (event) => {
            const input = event.target;
            let value = input.value;
            value = value.replace(/\D/g, ''); 

            const cardBrands = [
                { brand: 'Visa', pattern: /^4/ },
                { brand: 'Mastercard', pattern: /^5[1-5]/ },
                { brand: 'Amex', pattern: /^3[47]/ },
                { brand: 'Dinners', pattern: /^3[068]/ },
                { brand: 'Discover', pattern: /^6(?:011|5)/ },
                { brand: 'Hipercard', pattern: /^6(?:062|5)/ },
            ];

            let cardBrand = '';
            for (const brand of cardBrands) {
                if (brand.pattern.test(value)) {
                    cardBrand = brand.brand;
                    break;
                }
            }

            cardBrandSpan.textContent = cardBrand;
        });

        function getAddressByZipCode(zipcode) {
            axios.get(`https://viacep.com.br/ws/${zipcode}/json/`)
                .then(response => {
                    const endereco = response.data;
                    document.getElementById("country").value = "Brasil";
                    document.getElementById("logradouro").value = endereco.logradouro;
                    document.getElementById("neighborhood").value = endereco.bairro;
                    document.getElementById("city").value = endereco.localidade;
                    document.getElementById("state").value = endereco.uf;
                })
                .catch(error => {
                    document.getElementById("zipcode-error").textContent = "Invalid zip code";
                    console.error(error);
                });
        }

        function validateZipCode() {
            const zipcode = document.getElementById("zipCode").value;
            const zipcodePattern = /^[0-9]{8}$/;

            if (zipcodePattern.test(zipcode)) {
                getAddressByZipCode(zipcode);
                document.getElementById("zipcode-error").textContent = "";
            } else {
                document.getElementById("zipcode-error").textContent = "Invalid zip code";
            }
        }

        document.getElementById("zipCode").addEventListener("input", validateZipCode);

        function formatSSN(ssn) {
            ssn = ssn.replace(/\D/g, ''); 
            ssn = ssn.replace(/(\d{3})(\d)/, '$1-$2');
            ssn = ssn.replace(/(\d{2})(\d{4})$/, '$1-$2');
            return ssn;
        }

        function handleSSNInput() {
            const ssnInput = document.getElementById("ssn");
            ssnInput.value = formatSSN(ssnInput.value);
        }

        document.getElementById("ssn").addEventListener("input", handleSSNInput);


        function formatPhoneNumber(phoneNumber) {
            phoneNumber = phoneNumber.replace(/\D/g, '');
            phoneNumber = phoneNumber.replace(/^(\d{3})(\d)/, '$1-$2');
            phoneNumber = phoneNumber.replace(/(\d{3})(\d)/, '$1-$2'); 
            phoneNumber = phoneNumber.replace(/(\d{4})(\d)/, '$1$2'); 
            return phoneNumber;
        }

        function handlePhoneNumberInput() {
            const phoneNumberInput = document.getElementById("phoneNumber");
            phoneNumberInput.value = formatPhoneNumber(phoneNumberInput.value);
        }

        document.getElementById("phoneNumber").addEventListener("input", handlePhoneNumberInput);
    </script>
}

